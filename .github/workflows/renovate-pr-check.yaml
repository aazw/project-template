# .github/workflows/renovate-pr-check.yml
name: "Check Renovate Pull Request"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]
    paths:
      - "renovate.json"

permissions:
  contents: read

jobs:
  format-renovate-json:
    if: github.event.pull_request.user.login == 'renovate[bot]' || github.event.pull_request.user.login == 'renovate-bot'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          persist-credentials: false
      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
      - name: Format renovate.json
        run: npx --yes prettier -w renovate.json
      - name: Commit and push changes if needed
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |-
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # 1. 変更をコミット
            git commit -am "chore: format renovate.json"

            # 2. 最新リモートを取得してリベース（競合時に備えautostash）
            auth="$(printf 'x-access-token:%s' "$GITHUB_TOKEN" | base64 | tr -d '\n')"
            extraheader="AUTHORIZATION: basic $auth"
            git -c "http.${GITHUB_SERVER_URL}/.extraheader=$extraheader" fetch origin "$GITHUB_HEAD_REF"
            git rebase --autostash "origin/$GITHUB_HEAD_REF"

            # 3. リベース結果を force-with-lease で安全に push
            git -c "http.${GITHUB_SERVER_URL}/.extraheader=$extraheader" push --force-with-lease origin HEAD:"$GITHUB_HEAD_REF"
          else
            echo "No changes to commit."
          fi
